<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Details</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header class="header">
        <div class="header-logo">
            <a href="{{ url_for('web.index') }}">
                <img src = "{{ url_for('static', filename='images/logo.png') }}" alt="HBnB logo">
            </a>
        </div>
        <nav id="user-nav">
            {% if current_user %}
                <nav>
                    <a href="/profile/{{ current_user.id }}">
                    <img class="header-user-photo" src="{{ current_user.photo_url or '../static/images/default-user.png' }}" alt="Profil de {{ current_user.first_name }}">
                    {{ current_user.first_name }}
                    </a>
                    <a href="{{ url_for('web.logout') }}" id="logout-link">Logout</a>
                </nav>
            {% else %}
                <div class="header-auth">
                    <div class="header-registration">
                        <a href="{{ url_for('web.new_user') }}" id="registration-link">Créer un compte</a>
                    </div>
                    <p class="separation">|</p>
                    <div class="header-login">
                        <a href="{{ url_for('web.login') }}" id="login-link">Login</a>
                    </div>
                </div>
            {% endif %}
        </nav>
    </header>
    <main>
        <section id="place-details">
            <div class="photo-gallery">
                {% set default_img = url_for('static', filename="images/default-place-grey.png") %}
                {% set total_photos = photos_url|length %}
                {% for i in range(5) %}
                    {% set photo = photos_url[i] if total_photos > i else default_img %}
                    {% if i == 0 %}
                        <img class="place-photo-main" src="{{ photo }}" alt="Photo principale">
                    {% elif i == 1 %}
                        <img class="place-photo-little little-1" src="{{ photo }}" alt="Photo 1">
                    {% elif i == 2 %}
                        <img class="place-photo-little little-2" src="{{ photo }}" alt="Photo 2">
                    {% elif i == 3 %}
                        <img class="place-photo-little little-3" src="{{ photo }}" alt="Photo 3">
                    {% elif i == 4 %}
                        <img class="place-photo-little little-4" src="{{ photo }}" alt="Photo 4">
                    {% endif %}
                {% endfor %}
                <button class="show-all-photos-btn" onclick="openGalleryModal()">Voir toutes les photos</button>
            </div>
            <div class="place-info-card">
                <div class="place-title">
                    <h2>{{ place.title }}</h2>
                </div>
                <div class="place-location" data-latitude="{{ place.latitude }}" data-longitude="{{ place.longitude }}">
                    <p id="location-name">Chargement de la localisation...</p>
                </div>
                <div class="place-owner">
                    <img class="place-owner-photo" src="{{ place.owner.photo_url or '../static/images/default-user.png' }}" alt="Profil de {{ place.owner.first_name }}" data-user-photo="{{ place.owner.photo_url }}" data-user-name="{{ place.owner.first_name }} {{ place.owner.last_name }}">
                    <a class="place-owner-name" href="#" data-user-photo="{{ place.owner.photo_url }}" data-user-name="{{ place.owner.first_name }} {{ place.owner.last_name }}">{{ place.owner.first_name }} {{ place.owner.last_name }}</a>
                </div>
                <div class="place-description">
                    <p>{{ place.description }}</p>
                </div>
                <div class="place-price">
                    <p><bold>{{ "%.2f"|format(place.price) }}</bold> €/nuit</p>
                </div>
                <div class="next_booking">
                    {% set future_bookings = place.bookings | selectattr("end_date", ">", now) | selectattr("status", "equalto", "PENDING") | sort(attribute="end_date") %}
                    {% if future_bookings|length > 0 %}
                        Prochaine réservation disponible : {{ future_bookings[-1].end_date.strftime("%d/%m/%Y") }}
                    {% else %}
                        Disponible immédiatement
                    {% endif %}
                </div>
                <div>
                    <p class="place-card-rating">
                        {% set rating = place.rating or 0 %}
                        {% set note = ((rating * 2) | round) / 2 %}
                        {% if rating == 0 %}
                        <p>Pas encore de note</p>
                        {% else %}
                        {% for i in range(1, 6) %}
                            {% if i <= note %}
                            <span class="star">★</span>
                            {% elif i - 0.5 == note %}
                            <span class="star">⯪</span>
                            {% else %}
                            <span class="star">☆</span>
                            {% endif %}
                        {% endfor %}
                        <span class="place-card-rating-value">{{ note }}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </section>
        <section id="reviews">
            <div class="place-visited-check">
                {% if current_user %}
                    {% set has_visited = false %}
                    {% for booking in place.bookings %}
                        {% if booking.user == current_user.id and booking.status == DONE %}
                            {% set has_visited = true %}
                        {% endif %}
                    {% endfor %}
                    {% if has_visited %}
                        <nav>Vous avez séjourné dans l'hébergement de {{ place.owner.first_name }}:
                        <button class="button-to-review" type="redirect"><a href="{{ url_for('web.add_review') }}">Laissez votre avis</a></button>
                        </nav>
                    {% else %}
                            <nav>Vous n'avez pas encore séjourné dans l'hébergement de {{ place.owner.first_name }}:
                            <button class="button-to-booking" type="redirect"><a href="{{ url_for('web.new_booking') }}">Réservez maintenant</a></button>
                            </nav>
                    {% endif %}
                {% else %}
                    <nav>
                        Vous n'êtes pas connecté:
                    <button class="login-button-fromplace" type="redirect"><a href="{{ url_for('web.login') }}">Authentifiez-vous pour réserver</a></button>
                    </nav>
                {% endif %}
            </div>
            <div class="reviews-list">
            {% if reviews_list %}
                <h3>Les derniers avis laissés pour cet hébergement</h3>
                {% for review in reviews_list[:5] %}
                    <div class="review-card">
                        <div class="review-user-info">
                            <img class="review-user-photo" src="{{ review.user.photo_url or '../static/images/default-user.png' }}" alt="Profil de {{ review.user_first_name }}" data-user-name="{{ review.user_first_name }} {{ review.user_last_name }}" data-user-photo="{{ review.user.photo_url }}">
                            <a class="review-user-name" href="#" data-user-photo="{{ review.user.photo_url }}" data-user-name="{{ review.user_first_name }} {{ review.user_last_name }}">{{ review.user_first_name }} {{ review.user_last_name }}</a>
                        </div>
                        <p>A visité du {{ review.booking_rel.start_date.strftime('%d/%m/%Y') }} au {{ review.booking_rel.end_date.strftime('%d/%m/%Y') }}</p>
                        <p class="review-card-rating">
                            {% set rating = review.rating %}
                            {% set note = ((rating * 2) | round) / 2 %}
                            {% for i in range(1, 6) %}
                                {% if i <= note %}
                                    <span class="star">★</span>
                                {% elif i - 0.5 == note %}
                                    <span class="star">⯪</span>
                                {% else %}
                                    <span class="star">☆</span>
                                {% endif %}
                            {% endfor %}
                            <span class="review-card-rating-value">{{ note }}</span>
                        </p>
                        <p>{{ review.comment }}</p>
                    </div>
                {% endfor %}
            {% else %}
            <h3>Soyez la première personne à visiter cet endroit et laisser un avis.</h3>
            {% endif %}
                <button class="show-all-reviews-btn" onclick="openReviewsListModal()">Voir tous les avis</button>
                </div>
            </div>
        </section>
    </main>
    <div id="modal-overlay" class="hidden"></div>
    <div id="user-modal" class="user-card-modal hidden">
        <div class="user-modal-content">
            <span id="close-user-modal" class="close" style="cursor:pointer; font-size:24px;">&times;</span>
            <img id="modal-user-photo" src="" alt="Photo utilisateur" style="width:100px; border-radius: 50%;">
            <h2 id="modal-user-name"></h2>
            <button id="user-contact-button" class="message-button">Contactez-moi</button>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/user_popup.js') }}"></script>
    <script src="{{ url_for('static', filename='js/getcity.js') }}"></script>
</body>
</html>
